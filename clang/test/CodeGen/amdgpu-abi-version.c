// NOTE: Assertions have been autogenerated by utils/update_cc_test_checks.py UTC_ARGS: --check-globals all --version 4
// RUN: %clang_cc1 -cc1 -triple amdgcn-amd-amdhsa -emit-llvm -mcode-object-version=none %s -o - | FileCheck %s

//.
// CHECK: @__oclc_ABI_version = external addrspace(4) global i32
//.
// CHECK-LABEL: define dso_local i32 @workgroup_size(
// CHECK-SAME: i32 noundef [[DIM:%.*]]) #[[ATTR0:[0-9]+]] {
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[RETVAL:%.*]] = alloca i32, align 4, addrspace(5)
// CHECK-NEXT:    [[DIM_ADDR:%.*]] = alloca i32, align 4, addrspace(5)
// CHECK-NEXT:    [[RETVAL_ASCAST:%.*]] = addrspacecast ptr addrspace(5) [[RETVAL]] to ptr
// CHECK-NEXT:    [[DIM_ADDR_ASCAST:%.*]] = addrspacecast ptr addrspace(5) [[DIM_ADDR]] to ptr
// CHECK-NEXT:    store i32 [[DIM]], ptr [[DIM_ADDR_ASCAST]], align 4
// CHECK-NEXT:    [[TMP0:%.*]] = load i32, ptr [[DIM_ADDR_ASCAST]], align 4
// CHECK-NEXT:    switch i32 [[TMP0]], label [[SW_EPILOG:%.*]] [
// CHECK-NEXT:      i32 0, label [[SW_BB:%.*]]
// CHECK-NEXT:      i32 1, label [[SW_BB1:%.*]]
// CHECK-NEXT:      i32 2, label [[SW_BB3:%.*]]
// CHECK-NEXT:    ]
// CHECK:       sw.bb:
// CHECK-NEXT:    [[TMP1:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP2:%.*]] = icmp sge i32 [[TMP1]], 500
// CHECK-NEXT:    [[TMP3:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP4:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP3]], i32 12
// CHECK-NEXT:    [[TMP5:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP6:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP5]], i32 4
// CHECK-NEXT:    [[TMP7:%.*]] = select i1 [[TMP2]], ptr addrspace(4) [[TMP4]], ptr addrspace(4) [[TMP6]]
// CHECK-NEXT:    [[TMP8:%.*]] = load i16, ptr addrspace(4) [[TMP7]], align 2, !range [[RNG2:![0-9]+]], !invariant.load [[META3:![0-9]+]], !noundef [[META3]]
// CHECK-NEXT:    [[CONV:%.*]] = zext i16 [[TMP8]] to i32
// CHECK-NEXT:    store i32 [[CONV]], ptr [[RETVAL_ASCAST]], align 4
// CHECK-NEXT:    br label [[RETURN:%.*]]
// CHECK:       sw.bb1:
// CHECK-NEXT:    [[TMP9:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP10:%.*]] = icmp sge i32 [[TMP9]], 500
// CHECK-NEXT:    [[TMP11:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP12:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP11]], i32 14
// CHECK-NEXT:    [[TMP13:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP14:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP13]], i32 6
// CHECK-NEXT:    [[TMP15:%.*]] = select i1 [[TMP10]], ptr addrspace(4) [[TMP12]], ptr addrspace(4) [[TMP14]]
// CHECK-NEXT:    [[TMP16:%.*]] = load i16, ptr addrspace(4) [[TMP15]], align 2, !range [[RNG2]], !invariant.load [[META3]], !noundef [[META3]]
// CHECK-NEXT:    [[CONV2:%.*]] = zext i16 [[TMP16]] to i32
// CHECK-NEXT:    store i32 [[CONV2]], ptr [[RETVAL_ASCAST]], align 4
// CHECK-NEXT:    br label [[RETURN]]
// CHECK:       sw.bb3:
// CHECK-NEXT:    [[TMP17:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP18:%.*]] = icmp sge i32 [[TMP17]], 500
// CHECK-NEXT:    [[TMP19:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP20:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP19]], i32 16
// CHECK-NEXT:    [[TMP21:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP22:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP21]], i32 8
// CHECK-NEXT:    [[TMP23:%.*]] = select i1 [[TMP18]], ptr addrspace(4) [[TMP20]], ptr addrspace(4) [[TMP22]]
// CHECK-NEXT:    [[TMP24:%.*]] = load i16, ptr addrspace(4) [[TMP23]], align 2, !range [[RNG2]], !invariant.load [[META3]], !noundef [[META3]]
// CHECK-NEXT:    [[CONV4:%.*]] = zext i16 [[TMP24]] to i32
// CHECK-NEXT:    store i32 [[CONV4]], ptr [[RETVAL_ASCAST]], align 4
// CHECK-NEXT:    br label [[RETURN]]
// CHECK:       sw.epilog:
// CHECK-NEXT:    unreachable
// CHECK:       return:
// CHECK-NEXT:    [[TMP25:%.*]] = load i32, ptr [[RETVAL_ASCAST]], align 4
// CHECK-NEXT:    ret i32 [[TMP25]]
//
int workgroup_size(int dim) {
  switch(dim) {
    case 0:
      return __builtin_amdgcn_workgroup_size_x();
    case 1:
      return __builtin_amdgcn_workgroup_size_y();
    case 2:
      return __builtin_amdgcn_workgroup_size_z();
  }
  __builtin_unreachable();
}

// CHECK-LABEL: define dso_local i32 @num_workgroups(
// CHECK-SAME: i32 noundef [[DIM:%.*]]) #[[ATTR0]] {
// CHECK-NEXT:  entry:
// CHECK-NEXT:    [[RETVAL:%.*]] = alloca i32, align 4, addrspace(5)
// CHECK-NEXT:    [[DIM_ADDR:%.*]] = alloca i32, align 4, addrspace(5)
// CHECK-NEXT:    [[RETVAL_ASCAST:%.*]] = addrspacecast ptr addrspace(5) [[RETVAL]] to ptr
// CHECK-NEXT:    [[DIM_ADDR_ASCAST:%.*]] = addrspacecast ptr addrspace(5) [[DIM_ADDR]] to ptr
// CHECK-NEXT:    store i32 [[DIM]], ptr [[DIM_ADDR_ASCAST]], align 4
// CHECK-NEXT:    [[TMP0:%.*]] = load i32, ptr [[DIM_ADDR_ASCAST]], align 4
// CHECK-NEXT:    switch i32 [[TMP0]], label [[SW_EPILOG:%.*]] [
// CHECK-NEXT:      i32 0, label [[SW_BB:%.*]]
// CHECK-NEXT:      i32 1, label [[SW_BB1:%.*]]
// CHECK-NEXT:      i32 2, label [[SW_BB2:%.*]]
// CHECK-NEXT:    ]
// CHECK:       sw.bb:
// CHECK-NEXT:    [[TMP1:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP2:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP3:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP2]], i32 0
// CHECK-NEXT:    [[TMP4:%.*]] = load i32, ptr addrspace(4) [[TMP3]], align 2, !invariant.load [[META3]], !noundef [[META3]]
// CHECK-NEXT:    [[TMP5:%.*]] = icmp sge i32 [[TMP1]], 500
// CHECK-NEXT:    [[TMP6:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP7:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP6]], i32 12
// CHECK-NEXT:    [[TMP8:%.*]] = load i32, ptr addrspace(4) [[TMP7]], align 4, !invariant.load [[META3]]
// CHECK-NEXT:    [[TMP9:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP10:%.*]] = icmp sge i32 [[TMP9]], 500
// CHECK-NEXT:    [[TMP11:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP12:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP11]], i32 12
// CHECK-NEXT:    [[TMP13:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP14:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP13]], i32 4
// CHECK-NEXT:    [[TMP15:%.*]] = select i1 [[TMP10]], ptr addrspace(4) [[TMP12]], ptr addrspace(4) [[TMP14]]
// CHECK-NEXT:    [[TMP16:%.*]] = load i16, ptr addrspace(4) [[TMP15]], align 2, !range [[RNG2]], !invariant.load [[META3]], !noundef [[META3]]
// CHECK-NEXT:    [[TMP17:%.*]] = zext i16 [[TMP16]] to i32
// CHECK-NEXT:    [[TMP18:%.*]] = udiv i32 [[TMP8]], [[TMP17]]
// CHECK-NEXT:    [[TMP19:%.*]] = select i1 [[TMP5]], i32 [[TMP4]], i32 [[TMP18]]
// CHECK-NEXT:    store i32 [[TMP19]], ptr [[RETVAL_ASCAST]], align 4
// CHECK-NEXT:    br label [[RETURN:%.*]]
// CHECK:       sw.bb1:
// CHECK-NEXT:    [[TMP20:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP21:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP22:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP21]], i32 4
// CHECK-NEXT:    [[TMP23:%.*]] = load i32, ptr addrspace(4) [[TMP22]], align 2, !invariant.load [[META3]], !noundef [[META3]]
// CHECK-NEXT:    [[TMP24:%.*]] = icmp sge i32 [[TMP20]], 500
// CHECK-NEXT:    [[TMP25:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP26:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP25]], i32 16
// CHECK-NEXT:    [[TMP27:%.*]] = load i32, ptr addrspace(4) [[TMP26]], align 4, !invariant.load [[META3]]
// CHECK-NEXT:    [[TMP28:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP29:%.*]] = icmp sge i32 [[TMP28]], 500
// CHECK-NEXT:    [[TMP30:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP31:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP30]], i32 14
// CHECK-NEXT:    [[TMP32:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP33:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP32]], i32 6
// CHECK-NEXT:    [[TMP34:%.*]] = select i1 [[TMP29]], ptr addrspace(4) [[TMP31]], ptr addrspace(4) [[TMP33]]
// CHECK-NEXT:    [[TMP35:%.*]] = load i16, ptr addrspace(4) [[TMP34]], align 2, !range [[RNG2]], !invariant.load [[META3]], !noundef [[META3]]
// CHECK-NEXT:    [[TMP36:%.*]] = zext i16 [[TMP35]] to i32
// CHECK-NEXT:    [[TMP37:%.*]] = udiv i32 [[TMP27]], [[TMP36]]
// CHECK-NEXT:    [[TMP38:%.*]] = select i1 [[TMP24]], i32 [[TMP23]], i32 [[TMP37]]
// CHECK-NEXT:    store i32 [[TMP38]], ptr [[RETVAL_ASCAST]], align 4
// CHECK-NEXT:    br label [[RETURN]]
// CHECK:       sw.bb2:
// CHECK-NEXT:    [[TMP39:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP40:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP41:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP40]], i32 8
// CHECK-NEXT:    [[TMP42:%.*]] = load i32, ptr addrspace(4) [[TMP41]], align 2, !invariant.load [[META3]], !noundef [[META3]]
// CHECK-NEXT:    [[TMP43:%.*]] = icmp sge i32 [[TMP39]], 500
// CHECK-NEXT:    [[TMP44:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP45:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP44]], i32 20
// CHECK-NEXT:    [[TMP46:%.*]] = load i32, ptr addrspace(4) [[TMP45]], align 4, !invariant.load [[META3]]
// CHECK-NEXT:    [[TMP47:%.*]] = load i32, ptr addrspace(4) @__oclc_ABI_version, align 4
// CHECK-NEXT:    [[TMP48:%.*]] = icmp sge i32 [[TMP47]], 500
// CHECK-NEXT:    [[TMP49:%.*]] = call align 8 dereferenceable(256) ptr addrspace(4) @llvm.amdgcn.implicitarg.ptr()
// CHECK-NEXT:    [[TMP50:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP49]], i32 16
// CHECK-NEXT:    [[TMP51:%.*]] = call align 4 dereferenceable(64) ptr addrspace(4) @llvm.amdgcn.dispatch.ptr()
// CHECK-NEXT:    [[TMP52:%.*]] = getelementptr i8, ptr addrspace(4) [[TMP51]], i32 8
// CHECK-NEXT:    [[TMP53:%.*]] = select i1 [[TMP48]], ptr addrspace(4) [[TMP50]], ptr addrspace(4) [[TMP52]]
// CHECK-NEXT:    [[TMP54:%.*]] = load i16, ptr addrspace(4) [[TMP53]], align 2, !range [[RNG2]], !invariant.load [[META3]], !noundef [[META3]]
// CHECK-NEXT:    [[TMP55:%.*]] = zext i16 [[TMP54]] to i32
// CHECK-NEXT:    [[TMP56:%.*]] = udiv i32 [[TMP46]], [[TMP55]]
// CHECK-NEXT:    [[TMP57:%.*]] = select i1 [[TMP43]], i32 [[TMP42]], i32 [[TMP56]]
// CHECK-NEXT:    store i32 [[TMP57]], ptr [[RETVAL_ASCAST]], align 4
// CHECK-NEXT:    br label [[RETURN]]
// CHECK:       sw.epilog:
// CHECK-NEXT:    unreachable
// CHECK:       return:
// CHECK-NEXT:    [[TMP58:%.*]] = load i32, ptr [[RETVAL_ASCAST]], align 4
// CHECK-NEXT:    ret i32 [[TMP58]]
//
int num_workgroups(int dim) {
  switch(dim) {
    case 0:
      return __builtin_amdgcn_num_workgroups_x();
    case 1:
      return __builtin_amdgcn_num_workgroups_y();
    case 2:
      return __builtin_amdgcn_num_workgroups_z();
  }
  __builtin_unreachable();
}
