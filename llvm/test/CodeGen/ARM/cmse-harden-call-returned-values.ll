; NOTE: Assertions have been autogenerated by utils/update_llc_test_checks.py UTC_ARGS: --version 3
; RUN: llc %s -mtriple=thumbv8m.main     -o - | FileCheck %s --check-prefix V8M
; RUN: llc %s -mtriple=thumbebv8m.main   -o - | FileCheck %s --check-prefix V8M
; RUN: llc %s -mtriple=thumbv8.1m.main   -o - | FileCheck %s --check-prefix V81M
; RUN: llc %s -mtriple=thumbebv8.1m.main -o - | FileCheck %s --check-prefix V81M

@get_idx = hidden local_unnamed_addr global ptr null, align 4
@arr = hidden local_unnamed_addr global [256 x i32] zeroinitializer, align 4

define i32 @access_i16() {
; V8M-LABEL: access_i16:
; V8M:       @ %bb.0: @ %entry
; V8M-NEXT:    push {r7, lr}
; V8M-NEXT:    movw r0, :lower16:get_idx
; V8M-NEXT:    movt r0, :upper16:get_idx
; V8M-NEXT:    ldr r0, [r0]
; V8M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    bic r0, r0, #1
; V8M-NEXT:    sub sp, #136
; V8M-NEXT:    vlstm sp
; V8M-NEXT:    mov r1, r0
; V8M-NEXT:    mov r2, r0
; V8M-NEXT:    mov r3, r0
; V8M-NEXT:    mov r4, r0
; V8M-NEXT:    mov r5, r0
; V8M-NEXT:    mov r6, r0
; V8M-NEXT:    mov r7, r0
; V8M-NEXT:    mov r8, r0
; V8M-NEXT:    mov r9, r0
; V8M-NEXT:    mov r10, r0
; V8M-NEXT:    mov r11, r0
; V8M-NEXT:    mov r12, r0
; V8M-NEXT:    msr apsr_nzcvq, r0
; V8M-NEXT:    blxns r0
; V8M-NEXT:    vlldm sp
; V8M-NEXT:    add sp, #136
; V8M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    movw r1, :lower16:arr
; V8M-NEXT:    sxth r0, r0
; V8M-NEXT:    movt r1, :upper16:arr
; V8M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V8M-NEXT:    pop {r7, pc}
;
; V81M-LABEL: access_i16:
; V81M:       @ %bb.0: @ %entry
; V81M-NEXT:    push {r7, lr}
; V81M-NEXT:    movw r0, :lower16:get_idx
; V81M-NEXT:    movt r0, :upper16:get_idx
; V81M-NEXT:    ldr r0, [r0]
; V81M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    bic r0, r0, #1
; V81M-NEXT:    sub sp, #136
; V81M-NEXT:    vlstm sp
; V81M-NEXT:    clrm {r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, apsr}
; V81M-NEXT:    blxns r0
; V81M-NEXT:    vlldm sp
; V81M-NEXT:    add sp, #136
; V81M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    movw r1, :lower16:arr
; V81M-NEXT:    sxth r0, r0
; V81M-NEXT:    movt r1, :upper16:arr
; V81M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V81M-NEXT:    pop {r7, pc}
entry:
  %0 = load ptr, ptr @get_idx, align 4
  %call = tail call signext i16 %0() "cmse_nonsecure_call"
  %idxprom = sext i16 %call to i32
  %arrayidx = getelementptr inbounds [256 x i32], ptr @arr, i32 0, i32 %idxprom
  %1 = load i32, ptr %arrayidx, align 4
  ret i32 %1
}

define i32 @access_u16() {
; V8M-LABEL: access_u16:
; V8M:       @ %bb.0: @ %entry
; V8M-NEXT:    push {r7, lr}
; V8M-NEXT:    movw r0, :lower16:get_idx
; V8M-NEXT:    movt r0, :upper16:get_idx
; V8M-NEXT:    ldr r0, [r0]
; V8M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    bic r0, r0, #1
; V8M-NEXT:    sub sp, #136
; V8M-NEXT:    vlstm sp
; V8M-NEXT:    mov r1, r0
; V8M-NEXT:    mov r2, r0
; V8M-NEXT:    mov r3, r0
; V8M-NEXT:    mov r4, r0
; V8M-NEXT:    mov r5, r0
; V8M-NEXT:    mov r6, r0
; V8M-NEXT:    mov r7, r0
; V8M-NEXT:    mov r8, r0
; V8M-NEXT:    mov r9, r0
; V8M-NEXT:    mov r10, r0
; V8M-NEXT:    mov r11, r0
; V8M-NEXT:    mov r12, r0
; V8M-NEXT:    msr apsr_nzcvq, r0
; V8M-NEXT:    blxns r0
; V8M-NEXT:    vlldm sp
; V8M-NEXT:    add sp, #136
; V8M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    movw r1, :lower16:arr
; V8M-NEXT:    uxth r0, r0
; V8M-NEXT:    movt r1, :upper16:arr
; V8M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V8M-NEXT:    pop {r7, pc}
;
; V81M-LABEL: access_u16:
; V81M:       @ %bb.0: @ %entry
; V81M-NEXT:    push {r7, lr}
; V81M-NEXT:    movw r0, :lower16:get_idx
; V81M-NEXT:    movt r0, :upper16:get_idx
; V81M-NEXT:    ldr r0, [r0]
; V81M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    bic r0, r0, #1
; V81M-NEXT:    sub sp, #136
; V81M-NEXT:    vlstm sp
; V81M-NEXT:    clrm {r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, apsr}
; V81M-NEXT:    blxns r0
; V81M-NEXT:    vlldm sp
; V81M-NEXT:    add sp, #136
; V81M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    movw r1, :lower16:arr
; V81M-NEXT:    uxth r0, r0
; V81M-NEXT:    movt r1, :upper16:arr
; V81M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V81M-NEXT:    pop {r7, pc}
entry:
  %0 = load ptr, ptr @get_idx, align 4
  %call = tail call zeroext i16 %0() "cmse_nonsecure_call"
  %idxprom = zext i16 %call to i32
  %arrayidx = getelementptr inbounds [256 x i32], ptr @arr, i32 0, i32 %idxprom
  %1 = load i32, ptr %arrayidx, align 4
  ret i32 %1
}

define i32 @access_i8() {
; V8M-LABEL: access_i8:
; V8M:       @ %bb.0: @ %entry
; V8M-NEXT:    push {r7, lr}
; V8M-NEXT:    movw r0, :lower16:get_idx
; V8M-NEXT:    movt r0, :upper16:get_idx
; V8M-NEXT:    ldr r0, [r0]
; V8M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    bic r0, r0, #1
; V8M-NEXT:    sub sp, #136
; V8M-NEXT:    vlstm sp
; V8M-NEXT:    mov r1, r0
; V8M-NEXT:    mov r2, r0
; V8M-NEXT:    mov r3, r0
; V8M-NEXT:    mov r4, r0
; V8M-NEXT:    mov r5, r0
; V8M-NEXT:    mov r6, r0
; V8M-NEXT:    mov r7, r0
; V8M-NEXT:    mov r8, r0
; V8M-NEXT:    mov r9, r0
; V8M-NEXT:    mov r10, r0
; V8M-NEXT:    mov r11, r0
; V8M-NEXT:    mov r12, r0
; V8M-NEXT:    msr apsr_nzcvq, r0
; V8M-NEXT:    blxns r0
; V8M-NEXT:    vlldm sp
; V8M-NEXT:    add sp, #136
; V8M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    movw r1, :lower16:arr
; V8M-NEXT:    sxtb r0, r0
; V8M-NEXT:    movt r1, :upper16:arr
; V8M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V8M-NEXT:    pop {r7, pc}
;
; V81M-LABEL: access_i8:
; V81M:       @ %bb.0: @ %entry
; V81M-NEXT:    push {r7, lr}
; V81M-NEXT:    movw r0, :lower16:get_idx
; V81M-NEXT:    movt r0, :upper16:get_idx
; V81M-NEXT:    ldr r0, [r0]
; V81M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    bic r0, r0, #1
; V81M-NEXT:    sub sp, #136
; V81M-NEXT:    vlstm sp
; V81M-NEXT:    clrm {r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, apsr}
; V81M-NEXT:    blxns r0
; V81M-NEXT:    vlldm sp
; V81M-NEXT:    add sp, #136
; V81M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    movw r1, :lower16:arr
; V81M-NEXT:    sxtb r0, r0
; V81M-NEXT:    movt r1, :upper16:arr
; V81M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V81M-NEXT:    pop {r7, pc}
entry:
  %0 = load ptr, ptr @get_idx, align 4
  %call = tail call signext i8 %0() "cmse_nonsecure_call"
  %idxprom = sext i8 %call to i32
  %arrayidx = getelementptr inbounds [256 x i32], ptr @arr, i32 0, i32 %idxprom
  %1 = load i32, ptr %arrayidx, align 4
  ret i32 %1
}

define i32 @access_u8() {
; V8M-LABEL: access_u8:
; V8M:       @ %bb.0: @ %entry
; V8M-NEXT:    push {r7, lr}
; V8M-NEXT:    movw r0, :lower16:get_idx
; V8M-NEXT:    movt r0, :upper16:get_idx
; V8M-NEXT:    ldr r0, [r0]
; V8M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    bic r0, r0, #1
; V8M-NEXT:    sub sp, #136
; V8M-NEXT:    vlstm sp
; V8M-NEXT:    mov r1, r0
; V8M-NEXT:    mov r2, r0
; V8M-NEXT:    mov r3, r0
; V8M-NEXT:    mov r4, r0
; V8M-NEXT:    mov r5, r0
; V8M-NEXT:    mov r6, r0
; V8M-NEXT:    mov r7, r0
; V8M-NEXT:    mov r8, r0
; V8M-NEXT:    mov r9, r0
; V8M-NEXT:    mov r10, r0
; V8M-NEXT:    mov r11, r0
; V8M-NEXT:    mov r12, r0
; V8M-NEXT:    msr apsr_nzcvq, r0
; V8M-NEXT:    blxns r0
; V8M-NEXT:    vlldm sp
; V8M-NEXT:    add sp, #136
; V8M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    movw r1, :lower16:arr
; V8M-NEXT:    uxtb r0, r0
; V8M-NEXT:    movt r1, :upper16:arr
; V8M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V8M-NEXT:    pop {r7, pc}
;
; V81M-LABEL: access_u8:
; V81M:       @ %bb.0: @ %entry
; V81M-NEXT:    push {r7, lr}
; V81M-NEXT:    movw r0, :lower16:get_idx
; V81M-NEXT:    movt r0, :upper16:get_idx
; V81M-NEXT:    ldr r0, [r0]
; V81M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    bic r0, r0, #1
; V81M-NEXT:    sub sp, #136
; V81M-NEXT:    vlstm sp
; V81M-NEXT:    clrm {r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, apsr}
; V81M-NEXT:    blxns r0
; V81M-NEXT:    vlldm sp
; V81M-NEXT:    add sp, #136
; V81M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    movw r1, :lower16:arr
; V81M-NEXT:    uxtb r0, r0
; V81M-NEXT:    movt r1, :upper16:arr
; V81M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V81M-NEXT:    pop {r7, pc}
entry:
  %0 = load ptr, ptr @get_idx, align 4
  %call = tail call zeroext i8 %0() "cmse_nonsecure_call"
  %idxprom = zext i8 %call to i32
  %arrayidx = getelementptr inbounds [256 x i32], ptr @arr, i32 0, i32 %idxprom
  %1 = load i32, ptr %arrayidx, align 4
  ret i32 %1
}

define i32 @access_i1() {
; V8M-LABEL: access_i1:
; V8M:       @ %bb.0: @ %entry
; V8M-NEXT:    push {r7, lr}
; V8M-NEXT:    movw r0, :lower16:get_idx
; V8M-NEXT:    movt r0, :upper16:get_idx
; V8M-NEXT:    ldr r0, [r0]
; V8M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    bic r0, r0, #1
; V8M-NEXT:    sub sp, #136
; V8M-NEXT:    vlstm sp
; V8M-NEXT:    mov r1, r0
; V8M-NEXT:    mov r2, r0
; V8M-NEXT:    mov r3, r0
; V8M-NEXT:    mov r4, r0
; V8M-NEXT:    mov r5, r0
; V8M-NEXT:    mov r6, r0
; V8M-NEXT:    mov r7, r0
; V8M-NEXT:    mov r8, r0
; V8M-NEXT:    mov r9, r0
; V8M-NEXT:    mov r10, r0
; V8M-NEXT:    mov r11, r0
; V8M-NEXT:    mov r12, r0
; V8M-NEXT:    msr apsr_nzcvq, r0
; V8M-NEXT:    blxns r0
; V8M-NEXT:    vlldm sp
; V8M-NEXT:    add sp, #136
; V8M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    movw r1, :lower16:arr
; V8M-NEXT:    and r0, r0, #1
; V8M-NEXT:    movt r1, :upper16:arr
; V8M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V8M-NEXT:    pop {r7, pc}
;
; V81M-LABEL: access_i1:
; V81M:       @ %bb.0: @ %entry
; V81M-NEXT:    push {r7, lr}
; V81M-NEXT:    movw r0, :lower16:get_idx
; V81M-NEXT:    movt r0, :upper16:get_idx
; V81M-NEXT:    ldr r0, [r0]
; V81M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    bic r0, r0, #1
; V81M-NEXT:    sub sp, #136
; V81M-NEXT:    vlstm sp
; V81M-NEXT:    clrm {r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, apsr}
; V81M-NEXT:    blxns r0
; V81M-NEXT:    vlldm sp
; V81M-NEXT:    add sp, #136
; V81M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    movw r1, :lower16:arr
; V81M-NEXT:    and r0, r0, #1
; V81M-NEXT:    movt r1, :upper16:arr
; V81M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V81M-NEXT:    pop {r7, pc}
entry:
  %0 = load ptr, ptr @get_idx, align 4
  %call = tail call zeroext i1 %0() "cmse_nonsecure_call"
  %idxprom = zext i1 %call to i32
  %arrayidx = getelementptr inbounds [256 x i32], ptr @arr, i32 0, i32 %idxprom
  %1 = load i32, ptr %arrayidx, align 4
  ret i32 %1
}

define i32 @access_i5() {
; V8M-LABEL: access_i5:
; V8M:       @ %bb.0: @ %entry
; V8M-NEXT:    push {r7, lr}
; V8M-NEXT:    movw r0, :lower16:get_idx
; V8M-NEXT:    movt r0, :upper16:get_idx
; V8M-NEXT:    ldr r0, [r0]
; V8M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    bic r0, r0, #1
; V8M-NEXT:    sub sp, #136
; V8M-NEXT:    vlstm sp
; V8M-NEXT:    mov r1, r0
; V8M-NEXT:    mov r2, r0
; V8M-NEXT:    mov r3, r0
; V8M-NEXT:    mov r4, r0
; V8M-NEXT:    mov r5, r0
; V8M-NEXT:    mov r6, r0
; V8M-NEXT:    mov r7, r0
; V8M-NEXT:    mov r8, r0
; V8M-NEXT:    mov r9, r0
; V8M-NEXT:    mov r10, r0
; V8M-NEXT:    mov r11, r0
; V8M-NEXT:    mov r12, r0
; V8M-NEXT:    msr apsr_nzcvq, r0
; V8M-NEXT:    blxns r0
; V8M-NEXT:    vlldm sp
; V8M-NEXT:    add sp, #136
; V8M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    movw r1, :lower16:arr
; V8M-NEXT:    sbfx r0, r0, #0, #5
; V8M-NEXT:    movt r1, :upper16:arr
; V8M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V8M-NEXT:    pop {r7, pc}
;
; V81M-LABEL: access_i5:
; V81M:       @ %bb.0: @ %entry
; V81M-NEXT:    push {r7, lr}
; V81M-NEXT:    movw r0, :lower16:get_idx
; V81M-NEXT:    movt r0, :upper16:get_idx
; V81M-NEXT:    ldr r0, [r0]
; V81M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    bic r0, r0, #1
; V81M-NEXT:    sub sp, #136
; V81M-NEXT:    vlstm sp
; V81M-NEXT:    clrm {r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, apsr}
; V81M-NEXT:    blxns r0
; V81M-NEXT:    vlldm sp
; V81M-NEXT:    add sp, #136
; V81M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    movw r1, :lower16:arr
; V81M-NEXT:    sbfx r0, r0, #0, #5
; V81M-NEXT:    movt r1, :upper16:arr
; V81M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V81M-NEXT:    pop {r7, pc}
entry:
  %0 = load ptr, ptr @get_idx, align 4
  %call = tail call signext i5 %0() "cmse_nonsecure_call"
  %idxprom = sext i5 %call to i32
  %arrayidx = getelementptr inbounds [256 x i32], ptr @arr, i32 0, i32 %idxprom
  %1 = load i32, ptr %arrayidx, align 4
  ret i32 %1
}

define i32 @access_u5() {
; V8M-LABEL: access_u5:
; V8M:       @ %bb.0: @ %entry
; V8M-NEXT:    push {r7, lr}
; V8M-NEXT:    movw r0, :lower16:get_idx
; V8M-NEXT:    movt r0, :upper16:get_idx
; V8M-NEXT:    ldr r0, [r0]
; V8M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    bic r0, r0, #1
; V8M-NEXT:    sub sp, #136
; V8M-NEXT:    vlstm sp
; V8M-NEXT:    mov r1, r0
; V8M-NEXT:    mov r2, r0
; V8M-NEXT:    mov r3, r0
; V8M-NEXT:    mov r4, r0
; V8M-NEXT:    mov r5, r0
; V8M-NEXT:    mov r6, r0
; V8M-NEXT:    mov r7, r0
; V8M-NEXT:    mov r8, r0
; V8M-NEXT:    mov r9, r0
; V8M-NEXT:    mov r10, r0
; V8M-NEXT:    mov r11, r0
; V8M-NEXT:    mov r12, r0
; V8M-NEXT:    msr apsr_nzcvq, r0
; V8M-NEXT:    blxns r0
; V8M-NEXT:    vlldm sp
; V8M-NEXT:    add sp, #136
; V8M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V8M-NEXT:    movw r1, :lower16:arr
; V8M-NEXT:    and r0, r0, #31
; V8M-NEXT:    movt r1, :upper16:arr
; V8M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V8M-NEXT:    pop {r7, pc}
;
; V81M-LABEL: access_u5:
; V81M:       @ %bb.0: @ %entry
; V81M-NEXT:    push {r7, lr}
; V81M-NEXT:    movw r0, :lower16:get_idx
; V81M-NEXT:    movt r0, :upper16:get_idx
; V81M-NEXT:    ldr r0, [r0]
; V81M-NEXT:    push.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    bic r0, r0, #1
; V81M-NEXT:    sub sp, #136
; V81M-NEXT:    vlstm sp
; V81M-NEXT:    clrm {r1, r2, r3, r4, r5, r6, r7, r8, r9, r10, r11, r12, apsr}
; V81M-NEXT:    blxns r0
; V81M-NEXT:    vlldm sp
; V81M-NEXT:    add sp, #136
; V81M-NEXT:    pop.w {r4, r5, r6, r7, r8, r9, r10, r11}
; V81M-NEXT:    movw r1, :lower16:arr
; V81M-NEXT:    and r0, r0, #31
; V81M-NEXT:    movt r1, :upper16:arr
; V81M-NEXT:    ldr.w r0, [r1, r0, lsl #2]
; V81M-NEXT:    pop {r7, pc}
entry:
  %0 = load ptr, ptr @get_idx, align 4
  %call = tail call zeroext i5 %0() "cmse_nonsecure_call"
  %idxprom = zext i5 %call to i32
  %arrayidx = getelementptr inbounds [256 x i32], ptr @arr, i32 0, i32 %idxprom
  %1 = load i32, ptr %arrayidx, align 4
  ret i32 %1
}
