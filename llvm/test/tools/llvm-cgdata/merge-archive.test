# Merge an archive that has two object files having cgdata (__llvm_outline)

RUN: split-file %s %t

RUN: llc -filetype=obj -mtriple arm64-apple-darwin %t/merge-1.ll -o %t/merge-1.o
RUN: llc -filetype=obj -mtriple arm64-apple-darwin %t/merge-2.ll -o %t/merge-2.o
RUN: llvm-ar rcs %t/merge-archive.a %t/merge-1.o %t/merge-2.o
RUN: llvm-cgdata merge %t/merge-archive.a -o %t/merge-archive.cgdata
RUN: llvm-cgdata show %t/merge-archive.cgdata | FileCheck %s
CHECK: Outlined hash tree:
CHECK-NEXT:  Total Node Count: 4
CHECK-NEXT:  Terminal Node Count: 2
CHECK-NEXT:  Depth: 2

RUN: llvm-cgdata dump %t/merge-archive.cgdata | FileCheck %s --check-prefix TREE
TREE: # Outlined stable hash tree
TREE-NEXT: :outlined_hash_tree
TREE-NEXT: ---
TREE-NEXT: 0:
TREE-NEXT:   Hash:            0x0
TREE-NEXT:   Terminals:       0
TREE-NEXT:   SuccessorIds:    [ 1 ]
TREE-NEXT: 1:
TREE-NEXT:   Hash:            0x1
TREE-NEXT:   Terminals:       0
TREE-NEXT:   SuccessorIds:    [ 2, 3 ]
TREE-NEXT: 2:
TREE-NEXT:   Hash:            0x3
TREE-NEXT:   Terminals:       5
TREE-NEXT:   SuccessorIds:    [  ]
TREE-NEXT: 3:
TREE-NEXT:   Hash:            0x2
TREE-NEXT:   Terminals:       4
TREE-NEXT:   SuccessorIds:    [  ]
TREE-NEXT: ...

;--- merge-1.ll

; The .data is encoded in a binary form based on the following yaml form. See serialize() in OutlinedHashTreeRecord.cpp
;---
;0:
;  Hash:            0x0
;  Terminals:       0
;  SuccessorIds:    [ 1 ]
;1:
;  Hash:            0x1
;  Terminals:       0
;  SuccessorIds:    [ 2 ]
;2:
;  Hash:            0x2
;  Terminals:       4
;  SuccessorIds:    [  ]
;...

@.data = private unnamed_addr constant [72 x i8] c"\03\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\01\00\00\00\01\00\00\00\01\00\00\00\01\00\00\00\00\00\00\00\00\00\00\00\01\00\00\00\02\00\00\00\02\00\00\00\02\00\00\00\00\00\00\00\04\00\00\00\00\00\00\00", section "__DATA,__llvm_outline"

;--- merge-2.ll

; The .data is encoded in a binary form based on the following yaml form. See serialize() in OutlinedHashTreeRecord.cpp
;---
;0:
;  Hash:            0x0
;  Terminals:       0
;  SuccessorIds:    [ 1 ]
;1:
;  Hash:            0x1
;  Terminals:       0
;  SuccessorIds:    [ 2 ]
;2:
;  Hash:            0x3
;  Terminals:       5
;  SuccessorIds:    [  ]
;...

@.data = private unnamed_addr constant [72 x i8] c"\03\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\01\00\00\00\01\00\00\00\01\00\00\00\01\00\00\00\00\00\00\00\00\00\00\00\01\00\00\00\02\00\00\00\02\00\00\00\03\00\00\00\00\00\00\00\05\00\00\00\00\00\00\00", section "__DATA,__llvm_outline"
