# Test merge a single object file into a cgdata

RUN: split-file %s %t

# Merge an object file that has no cgdata (__llvm_outline). It still produces a header only cgdata.
RUN: llc -filetype=obj -mtriple arm64-apple-darwin %t/merge-empty.ll -o %t/merge-empty.o
RUN: llvm-cgdata merge %t/merge-empty.o -o %t/merge-empty.cgdata
RUN: llvm-cgdata show %t/merge-empty.cgdata | FileCheck %s --allow-empty --check-prefix EMPTY
EMPTY-NOT: any


# Merge an object file having cgdata (__llvm_outline)
RUN: llc -filetype=obj -mtriple arm64-apple-darwin %t/merge-single.ll -o %t/merge-single.o
RUN: llvm-cgdata merge %t/merge-single.o -o %t/merge-single.cgdata
RUN: llvm-cgdata show %t/merge-single.cgdata | FileCheck %s
CHECK: Outlined hash tree:
CHECK-NEXT:  Total Node Count: 3
CHECK-NEXT:  Terminal Node Count: 1
CHECK-NEXT:  Depth: 2

;--- merge-empty.ll
@.data = private unnamed_addr constant [1 x i8] c"\01"

;--- merge-single.ll

; The .data is encoded in a binary form based on the following yaml form. See serialize() in OutlinedHashTreeRecord.cpp
;---
;0:
;  Hash:            0x0
;  Terminals:       0
;  SuccessorIds:    [ 1 ]
;1:
;  Hash:            0x1
;  Terminals:       0
;  SuccessorIds:    [ 2 ]
;2:
;  Hash:            0x2
;  Terminals:       4
;  SuccessorIds:    [  ]
;...

@.data = private unnamed_addr constant [72 x i8] c"\03\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\01\00\00\00\01\00\00\00\01\00\00\00\01\00\00\00\00\00\00\00\00\00\00\00\01\00\00\00\02\00\00\00\02\00\00\00\02\00\00\00\00\00\00\00\04\00\00\00\00\00\00\00", section "__DATA,__llvm_outline"

